import{c as C,d as E,e as I,u as q,r as m,j as e,A as b,U as F,w as A,x as f,g as D,a as l,s as x}from"./index-Bh9ycJS2.js";import{u as L,C as w}from"./useShippingSettings-DHNL54sW.js";import{C as z}from"./chevron-right-DSRHM6qT.js";/**
 * @license lucide-react v0.344.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const T=C("MapPin",[["path",{d:"M20 10c0 6-8 12-8 12s-8-6-8-12a8 8 0 0 1 16 0Z",key:"2oe9fu"}],["circle",{cx:"12",cy:"10",r:"3",key:"ilqhr7"}]]);/**
 * @license lucide-react v0.344.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const O=C("Package2",[["path",{d:"M3 9h18v10a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V9Z",key:"1ront0"}],["path",{d:"m3 9 2.45-4.9A2 2 0 0 1 7.24 3h9.52a2 2 0 0 1 1.8 1.1L21 9",key:"19h2x1"}],["path",{d:"M12 3v6",key:"1holv5"}]]);function V(){const y=E(),i=I(),{settings:u}=L(),{user:n}=q(),[h,g]=m.useState(!1),[t,j]=m.useState(1),[a,d]=m.useState(()=>{const s=sessionStorage.getItem("checkout-form");return s?JSON.parse(s):{fullName:"",email:"",phone:"",address:"",city:"",postalCode:"",country:"Colombia",paymentMethod:""}});m.useEffect(()=>{sessionStorage.setItem("checkout-form",JSON.stringify(a))},[a]),m.useEffect(()=>{n&&n.full_name&&n.email&&d(s=>({...s,fullName:s.fullName||n.full_name||"",email:s.email||n.email||"",phone:s.phone||n.phone||""}))},[n]);const k=s=>{console.log("Iniciando redirección a Mercado Pago:",s),i.clearCart(),sessionStorage.removeItem("checkout-form"),window.location.href=s},_=async s=>{if(s.preventDefault(),h){console.log("Formulario ya en proceso, ignorando envío adicional");return}if(!i.items.length){l.error("El carrito está vacío");return}if(!a.paymentMethod){l.error("Por favor selecciona un método de pago");return}g(!0);try{console.log("Iniciando proceso de checkout");const{data:r,error:v}=await x.from("orders").insert({user_id:(n==null?void 0:n.id)||null,shipping_address:{full_name:a.fullName,address:a.address,city:a.city,postal_code:a.postalCode,country:a.country,phone:a.phone},guest_info:{full_name:a.fullName,email:a.email,phone:a.phone},payment_method:a.paymentMethod,total:i.total,status:a.paymentMethod==="mercadopago"?"payment_pending":"processing",payment_status:a.paymentMethod==="mercadopago"?"awaiting_payment":"pending_cod",is_guest:!n}).select().single();if(v)throw v;console.log("Orden creada con ID:",r.id);const $=i.items.map(o=>({order_id:r.id,product_id:o.product.id,quantity:o.quantity,price_at_time:o.product.price,selected_color:o.selectedColor})),{error:N}=await x.from("order_items").insert($);if(N)throw N;if(console.log("Items del pedido creados correctamente"),a.paymentMethod==="mercadopago")try{console.log("Iniciando proceso de pago con Mercado Pago");const{data:o,error:c}=await x.functions.invoke("create-payment",{body:{orderId:r.id,items:i.items.map(p=>({product:{name:p.product.name,price:Number(p.product.price)},quantity:p.quantity})),total:i.total}});if(c||!(o!=null&&o.init_point))throw new Error((c==null?void 0:c.message)||"Error al crear preferencia de pago");console.log("Preferencia de pago creada:",o),k(o.init_point);return}catch(o){console.error("Error en proceso de Mercado Pago:",o),l.error("Error al conectar con MercadoPago. Intenta nuevamente.");try{await x.from("orders").delete().eq("id",r.id)}catch(c){console.error("Error al eliminar orden huérfana:",c)}g(!1);return}else{console.log("Procesando pago contra entrega"),await x.from("orders").update({status:"processing",payment_status:"pending_cod"}).eq("id",r.id),i.clearCart(),sessionStorage.removeItem("checkout-form"),l.success("Pedido realizado con éxito"),y(`/pago?status=pending_cod&order_id=${r.id}`);return}}catch(r){console.error("Error general en proceso de checkout:",r),l.error("Error al procesar el pedido"),g(!1)}},M=()=>t===1?!a.fullName||!a.email||!a.phone?(l.error("Por favor completa todos los campos de contacto"),!1):a.email.includes("@")?!0:(l.error("Por favor ingresa un email válido"),!1):t===2&&(!a.address||!a.city||!a.postalCode)?(l.error("Por favor completa todos los campos de envío"),!1):!0,P=()=>{M()&&j(t+1)},S=()=>{j(t-1)};return e.jsxs("div",{className:"min-h-screen bg-gray-50",children:[e.jsx("div",{className:"bg-white shadow-sm",children:e.jsx("div",{className:"max-w-7xl mx-auto px-4 sm:px-6 lg:px-8",children:e.jsxs("div",{className:"flex justify-between items-center py-4",children:[e.jsxs("button",{onClick:()=>y("/"),className:"flex items-center text-gray-600 hover:text-gray-900",children:[e.jsx(b,{className:"h-5 w-5 mr-2"}),"Volver a la tienda"]}),e.jsxs("div",{className:"text-sm text-gray-500",children:["Carrito (",i.items.length," ",i.items.length===1?"producto":"productos",")"]})]})})}),e.jsx("div",{className:"max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8",children:e.jsxs("div",{className:"lg:grid lg:grid-cols-12 lg:gap-x-12 lg:items-start",children:[e.jsxs("div",{className:"lg:col-span-7",children:[e.jsx("div",{className:"mb-8",children:e.jsxs("div",{className:"relative",children:[e.jsx("div",{className:"absolute inset-0 flex items-center","aria-hidden":"true",children:e.jsx("div",{className:"w-full border-t border-gray-200"})}),e.jsxs("div",{className:"relative flex justify-between",children:[e.jsxs("div",{className:"flex items-center",children:[e.jsxs("span",{className:`relative flex h-8 w-8 items-center justify-center rounded-full ${t>=1?"bg-indigo-600":"bg-gray-100"}`,children:[e.jsx(F,{className:`h-5 w-5 ${t>=1?"text-white":"text-gray-500"}`}),e.jsx("span",{className:"sr-only",children:"Información de contacto"})]}),e.jsx("span",{className:`ml-2 text-sm font-medium ${t>=1?"text-indigo-600":"text-gray-500"}`,children:"Contacto"})]}),e.jsxs("div",{className:"flex items-center",children:[e.jsxs("span",{className:`relative flex h-8 w-8 items-center justify-center rounded-full ${t>=2?"bg-indigo-600":"bg-gray-100"}`,children:[e.jsx(T,{className:`h-5 w-5 ${t>=2?"text-white":"text-gray-500"}`}),e.jsx("span",{className:"sr-only",children:"Información de envío"})]}),e.jsx("span",{className:`ml-2 text-sm font-medium ${t>=2?"text-indigo-600":"text-gray-500"}`,children:"Envío"})]}),e.jsxs("div",{className:"flex items-center",children:[e.jsxs("span",{className:`relative flex h-8 w-8 items-center justify-center rounded-full ${t>=3?"bg-indigo-600":"bg-gray-100"}`,children:[e.jsx(w,{className:`h-5 w-5 ${t>=3?"text-white":"text-gray-500"}`}),e.jsx("span",{className:"sr-only",children:"Método de pago"})]}),e.jsx("span",{className:`ml-2 text-sm font-medium ${t>=3?"text-indigo-600":"text-gray-500"}`,children:"Pago"})]})]})]})}),e.jsxs("div",{className:"bg-white rounded-lg shadow-sm p-6 mb-6",children:[e.jsxs(A,{mode:"wait",children:[t===1&&e.jsxs(f.div,{initial:{opacity:0,x:-20},animate:{opacity:1,x:0},exit:{opacity:0,x:20},children:[e.jsx("h2",{className:"text-lg font-medium text-gray-900 mb-4",children:"Información de contacto"}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx("label",{htmlFor:"fullName",className:"block text-sm font-medium text-gray-700",children:"Nombre completo"}),e.jsx("div",{className:"mt-1",children:e.jsx("input",{type:"text",id:"fullName",name:"fullName",value:a.fullName,onChange:s=>d(r=>({...r,fullName:s.target.value})),className:"block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm",required:!0})})]}),e.jsxs("div",{children:[e.jsx("label",{htmlFor:"email",className:"block text-sm font-medium text-gray-700",children:"Correo electrónico"}),e.jsx("div",{className:"mt-1",children:e.jsx("input",{type:"email",id:"email",name:"email",value:a.email,onChange:s=>d(r=>({...r,email:s.target.value})),className:"block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm",required:!0})})]}),e.jsxs("div",{children:[e.jsx("label",{htmlFor:"phone",className:"block text-sm font-medium text-gray-700",children:"Teléfono"}),e.jsx("div",{className:"mt-1",children:e.jsx("input",{type:"tel",id:"phone",name:"phone",value:a.phone,onChange:s=>d(r=>({...r,phone:s.target.value})),className:"block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm",required:!0})})]})]})]},"contact"),t===2&&e.jsxs(f.div,{initial:{opacity:0,x:-20},animate:{opacity:1,x:0},exit:{opacity:0,x:20},children:[e.jsx("h2",{className:"text-lg font-medium text-gray-900 mb-4",children:"Información de envío"}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx("label",{htmlFor:"address",className:"block text-sm font-medium text-gray-700",children:"Dirección"}),e.jsx("div",{className:"mt-1",children:e.jsx("input",{type:"text",id:"address",name:"address",value:a.address,onChange:s=>d(r=>({...r,address:s.target.value})),className:"block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm",required:!0})})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx("label",{htmlFor:"city",className:"block text-sm font-medium text-gray-700",children:"Ciudad"}),e.jsx("div",{className:"mt-1",children:e.jsx("input",{type:"text",id:"city",name:"city",value:a.city,onChange:s=>d(r=>({...r,city:s.target.value})),className:"block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm",required:!0})})]}),e.jsxs("div",{children:[e.jsx("label",{htmlFor:"postalCode",className:"block text-sm font-medium text-gray-700",children:"Código postal"}),e.jsx("div",{className:"mt-1",children:e.jsx("input",{type:"text",id:"postalCode",name:"postalCode",value:a.postalCode,onChange:s=>d(r=>({...r,postalCode:s.target.value})),className:"block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm",required:!0})})]})]})]})]},"shipping"),t===3&&e.jsxs(f.div,{initial:{opacity:0,x:-20},animate:{opacity:1,x:0},exit:{opacity:0,x:20},children:[e.jsx("h2",{className:"text-lg font-medium text-gray-900 mb-4",children:"Método de pago"}),e.jsxs("div",{className:"space-y-4",children:[e.jsx("div",{className:"relative",children:e.jsxs("div",{className:`flex items-center p-4 border rounded-lg cursor-pointer ${a.paymentMethod==="cash_on_delivery"?"border-indigo-500 bg-indigo-50":"border-gray-300 hover:border-indigo-500"}`,onClick:()=>d(s=>({...s,paymentMethod:"cash_on_delivery"})),children:[e.jsx("div",{className:"flex-shrink-0",children:e.jsx(O,{className:`h-6 w-6 ${a.paymentMethod==="cash_on_delivery"?"text-indigo-600":"text-gray-400"}`})}),e.jsxs("div",{className:"ml-3",children:[e.jsx("h3",{className:"text-sm font-medium text-gray-900",children:"Pago contra entrega"}),e.jsx("p",{className:"text-sm text-gray-500",children:"Paga cuando recibas tu pedido"})]})]})}),e.jsx("div",{className:"relative",children:e.jsxs("div",{className:`flex items-center p-4 border rounded-lg cursor-pointer ${a.paymentMethod==="mercadopago"?"border-indigo-500 bg-indigo-50":"border-gray-300 hover:border-indigo-500"}`,onClick:()=>d(s=>({...s,paymentMethod:"mercadopago"})),children:[e.jsx("div",{className:"flex-shrink-0",children:e.jsx(w,{className:`h-6 w-6 ${a.paymentMethod==="mercadopago"?"text-indigo-600":"text-gray-400"}`})}),e.jsxs("div",{className:"ml-3",children:[e.jsx("h3",{className:"text-sm font-medium text-gray-900",children:"Pagar con Mercado Pago"}),e.jsx("p",{className:"text-sm text-gray-500",children:"Tarjeta de crédito, débito o transferencia"})]})]})})]})]},"payment")]}),e.jsxs("div",{className:"mt-8 flex justify-between",children:[t>1&&e.jsxs("button",{type:"button",onClick:S,className:"inline-flex items-center px-4 py-2 border border-gray-300 shadow-sm text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500",children:[e.jsx(b,{className:"h-4 w-4 mr-2"}),"Anterior"]}),t<3?e.jsxs("button",{type:"button",onClick:P,className:"inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500",children:["Siguiente",e.jsx(z,{className:"h-4 w-4 ml-2"})]}):e.jsx("button",{type:"button",onClick:_,disabled:h,className:"inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 disabled:opacity-50 disabled:cursor-not-allowed",children:h?e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"animate-spin rounded-full h-4 w-4 border-b-2 border-white mr-2"}),"Procesando..."]}):"Finalizar compra"})]})]})]}),e.jsx("div",{className:"lg:col-span-5",children:e.jsxs("div",{className:"bg-white rounded-lg shadow-sm p-6",children:[e.jsx("h2",{className:"text-lg font-medium text-gray-900 mb-4",children:"Resumen del pedido"}),e.jsx("div",{className:"flow-root",children:e.jsx("ul",{role:"list",className:"-my-6 divide-y divide-gray-200",children:i.items.map(s=>e.jsxs("li",{className:"py-6 flex",children:[e.jsx("div",{className:"flex-shrink-0 w-24 h-24 border border-gray-200 rounded-md overflow-hidden",children:e.jsx("img",{src:s.product.images[0],alt:s.product.name,className:"w-full h-full object-center object-cover"})}),e.jsxs("div",{className:"ml-4 flex-1 flex flex-col",children:[e.jsxs("div",{children:[e.jsxs("div",{className:"flex justify-between text-base font-medium text-gray-900",children:[e.jsx("h3",{children:s.product.name}),e.jsxs("p",{className:"ml-4",children:["$",(s.product.price*s.quantity).toFixed(2)]})]}),s.selectedColor&&e.jsxs("p",{className:"mt-1 text-sm text-gray-500",children:["Color: ",s.selectedColor]})]}),e.jsx("div",{className:"flex-1 flex items-end justify-between text-sm",children:e.jsxs("p",{className:"text-gray-500",children:["Cantidad: ",s.quantity]})})]})]},`${s.product.id}-${s.selectedColor||""}`))})}),e.jsxs("div",{className:"border-t border-gray-200 mt-6 pt-6",children:[e.jsxs("div",{className:"flex justify-between text-base font-medium text-gray-900",children:[e.jsx("p",{children:"Subtotal"}),e.jsxs("p",{children:["$",i.total.toFixed(2)]})]}),e.jsx("p",{className:"mt-0.5 text-sm text-gray-500",children:"Envío calculado al finalizar la compra."}),e.jsx("div",{className:"mt-6",children:e.jsxs("div",{className:"flex items-center",children:[e.jsx(D,{className:"h-5 w-5 text-green-500"}),e.jsx("span",{className:"ml-2 text-sm text-gray-500",children:u!=null&&u.free_shipping_enabled?`Envío gratis en compras mayores a $${u.free_shipping_threshold.toLocaleString()}`:"Envío calculado al finalizar la compra"})]})})]})]})})]})})]})}export{V as GuestCheckout,V as default};
