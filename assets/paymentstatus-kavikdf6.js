import{t as C,d as A,e as E,r as w,j as t,A as k,s as l,C as T}from"./index-Bh9ycJS2.js";import{X as S,C as q}from"./x-circle-Ju8FmUhG.js";function D(){const[m]=C(),a=A(),r=m.get("status"),s=m.get("order_id"),u=E(o=>o.clearCart);w.useEffect(()=>{(async()=>{var n,g,p,y,f,h,x,P,v;if(r==="approved"&&s){console.log("[PaymentStatus] Payment approved for orderId:",s);try{const{data:e,error:c}=await l.from("orders").select(`
              id,
              guest_info,
              shipping_address,
              payment_method,
              total,
              order_items (
                quantity,
                price_at_time,
                selected_color,
                products (name, price)
              )
            `).eq("id",s).single();if(c||!e)console.error("[PaymentStatus] Error fetching order details for notification:",c==null?void 0:c.message);else{console.log("[PaymentStatus] Updating order status to confirmed");const{error:N}=await l.from("orders").update({status:"processing",payment_status:"paid"}).eq("id",s);N?console.error("[PaymentStatus] Error updating order status:",N.message):console.log("[PaymentStatus] Order status updated successfully to processing/paid"),console.log("[PaymentStatus] Order details fetched:",e);const b={fullName:((n=e.shipping_address)==null?void 0:n.full_name)||((g=e.guest_info)==null?void 0:g.full_name)||"N/A",email:((p=e.guest_info)==null?void 0:p.email)||"N/A",phone:((y=e.shipping_address)==null?void 0:y.phone)||((f=e.guest_info)==null?void 0:f.phone)||"N/A",address:((h=e.shipping_address)==null?void 0:h.address)||"N/A",city:((x=e.shipping_address)==null?void 0:x.city)||"N/A",postalCode:((P=e.shipping_address)==null?void 0:P.postal_code)||"N/A",country:((v=e.shipping_address)==null?void 0:v.country)||"N/A",orderId:e.id,paymentMethod:e.payment_method,totalAmount:Number(e.total).toFixed(2),items:e.order_items.map(d=>({product:{name:d.products.name,price:Number(d.products.price)},quantity:d.quantity,selectedColor:d.selected_color||"N/A"}))};console.log("[PaymentStatus] Attempting to send notification email for approved order:",b);const{error:_}=await l.functions.invoke("send-order-notification",{body:{orderData:b}});_?console.error("[PaymentStatus] Error sending approved order notification email:",_.message):console.log("[PaymentStatus] Approved order notification email function invoked.")}u(),sessionStorage.removeItem("checkout-form-bolt-v3"),console.log("[PaymentStatus] Cart and form data cleared for successful payment.")}catch(e){console.error("[PaymentStatus] Exception during successful payment handling:",e.message)}const j=setTimeout(()=>{a("/")},5e3);return()=>clearTimeout(j)}})()},[r,s,a,u]),w.useEffect(()=>{(async()=>{if((r==="rejected"||r==="failure")&&s){console.log("[PaymentStatus] Payment failed, cleaning up order:",s);try{console.log("[PaymentStatus] Order remains in payment_pending state for audit")}catch(n){console.error("[PaymentStatus] Error during failed payment cleanup:",n.message)}}})()},[r,s]);const i=(()=>{switch(r){case"approved":return{icon:t.jsx(q,{className:"h-16 w-16 text-green-500"}),title:"¡Pago exitoso!",message:"Tu pago ha sido procesado correctamente. Hemos enviado una notificación a tu correo y serás redirigido al inicio en 5 segundos.",actions:[{text:"Volver al inicio ahora",action:()=>a("/"),style:"bg-green-600 hover:bg-green-700 text-white",isPrimary:!0}]};case"rejected":return{icon:t.jsx(S,{className:"h-16 w-16 text-red-500"}),title:"Pago rechazado",message:"Lo sentimos, tu pago no pudo ser procesado. Por favor intenta de nuevo.",actions:[{text:"Elegir otro medio de pago",action:()=>a("/checkout"),style:"bg-red-600 hover:bg-red-700 text-white",isPrimary:!0},{text:"Volver al inicio",action:()=>a("/"),style:"bg-gray-200 hover:bg-gray-300 text-gray-700",isPrimary:!1}]};case"pending_cod":case"pending":return{icon:t.jsx(T,{className:"h-16 w-16 text-yellow-500"}),title:"Pago pendiente",message:r==="pending_cod"?"Tu pedido contra entrega ha sido recibido y está siendo procesado. Te hemos enviado una notificación por correo.":"Tu pago está siendo procesado. Te notificaremos cuando se confirme.",actions:[{text:"Volver al inicio",action:()=>a("/"),style:"bg-yellow-600 hover:bg-yellow-700 text-white",isPrimary:!0}]};default:return{icon:t.jsx(S,{className:"h-16 w-16 text-gray-500"}),title:"Estado desconocido",message:"No pudimos determinar el estado de tu pago. Contacta a soporte si el problema persiste.",actions:[{text:"Volver al inicio",action:()=>a("/"),style:"bg-gray-600 hover:bg-gray-700 text-white",isPrimary:!0}]}}})();return t.jsxs("div",{className:"min-h-screen bg-gray-50 flex flex-col",children:[t.jsx("div",{className:"flex items-center p-4 border-b bg-white shadow-sm",children:t.jsx("button",{onClick:()=>a("/"),className:"text-gray-600 hover:text-gray-900 focus:outline-none",children:t.jsx(k,{className:"h-6 w-6"})})}),t.jsx("div",{className:"flex-1 flex items-center justify-center p-4",children:t.jsxs("div",{className:"max-w-md w-full bg-white shadow rounded-lg p-8 text-center",children:[t.jsx("div",{className:"flex justify-center mb-6",children:i.icon}),t.jsx("h2",{className:"text-2xl font-bold text-gray-900 mb-4",children:i.title}),t.jsx("p",{className:"text-gray-600 mb-8",children:i.message}),t.jsx("div",{className:"space-y-4",children:i.actions.map((o,n)=>t.jsx("button",{onClick:o.action,className:`w-full py-3 px-4 rounded-md font-medium focus:outline-none focus:ring-2 focus:ring-offset-2 ${o.style} ${o.isPrimary?"":"border border-gray-300"}`,children:o.text},n))})]})})]})}export{D as PaymentStatus};
